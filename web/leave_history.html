<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è«‹å‡ç´€éŒ„æŸ¥è©¢ - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
        .pending { background: #fff3e0; color: #ef6c00; }
        .approved { background: #e8f5e9; color: #2e7d32; }
        .rejected { background: #ffejef; color: #c62828; }
        .filter-section { display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; }
        .filter-section label { margin-bottom: 0; flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <hgroup>
                <h1>ğŸ“… è«‹å‡ç´€éŒ„æŸ¥è©¢</h1>
                <p id="view-type-text">æ­£åœ¨è¼‰å…¥ç´€éŒ„...</p>
            </hgroup>
            <nav>
                <ul>
                    <li><button class="outline" onclick="location.href='portal.html'">è¿”å›ä¸»é¸å–®</button></li>
                </ul>
            </nav>
        </header>

        <main class="card">
            <div class="filter-section">
                <label>å‡åˆ¥ç¯©é¸
                    <select id="filter-type" onchange="filterData()">
                        <option value="å…¨éƒ¨">å…¨éƒ¨å‡åˆ¥</option>
                        <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
                        <option value="äº‹å‡">äº‹å‡</option>
                        <option value="ç—…å‡">ç—…å‡</option>
                    </select>
                </label>
                <label>ç‹€æ…‹ç¯©é¸
                    <select id="filter-status" onchange="filterData()">
                        <option value="å…¨éƒ¨">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="pending">å¾…å¯©æ ¸</option>
                        <option value="approved">å·²æ ¸å‡†</option>
                        <option value="rejected">å·²é§å›</option>
                    </select>
                </label>
                <button onclick="fetchLogs()" class="secondary">é‡æ–°æ•´ç†</button>
            </div>

            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th>ç”³è«‹æ—¥æœŸ</th>
                            <th id="th-name">å“¡å·¥å§“å</th>
                            <th>å‡åˆ¥</th>
                            <th>è«‹å‡æœŸé–“</th>
                            <th>æ™‚æ•¸</th>
                            <th>ç‹€æ…‹</th>
                            <th>åŸå› </th>
                        </tr>
                    </thead>
                    <tbody id="log-table">
                        <tr><td colspan="7" aria-busy="true">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <script>
        const uEmail = localStorage.getItem('userEmail');
        const uRole = localStorage.getItem('userRole'); // å‡è¨­æ‚¨åœ¨ç™»å…¥æ™‚æœ‰å­˜è§’è‰² (admin æˆ– employee)
        let allLogs = [];

        window.onload = function() {
            if (!uEmail) { window.location.href = "index.html"; return; }
            
            // ä»‹é¢å¾®èª¿
            if (uRole !== 'admin') {
                document.getElementById('th-name').style.display = 'none';
                document.getElementById('view-type-text').innerText = "å€‹äººè«‹å‡æ­·å²ç´€éŒ„";
            } else {
                document.getElementById('view-type-text').innerText = "ç®¡ç†å“¡æ¨¡å¼ï¼šå…¨å…¬å¸è«‹å‡ç´€éŒ„";
            }
            
            fetchLogs();
        };

        async function fetchLogs() {
            let query = _supabase.from('leave_requests').select('*').order('created_at', { ascending: false });

            // å¦‚æœä¸æ˜¯ç®¡ç†å“¡ï¼ŒåªæŠ“è‡ªå·±çš„è³‡æ–™
            if (uRole !== 'admin') {
                query = query.eq('user_email', uEmail);
            }

            const { data, error } = await query;

            if (error) {
                alert("æŠ“å–è³‡æ–™å¤±æ•—ï¼š" + error.message);
                return;
            }

            allLogs = data;
            renderTable(allLogs);
        }

        function renderTable(list) {
            const tbody = document.getElementById('log-table');
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">æŸ¥ç„¡è«‹å‡ç´€éŒ„ã€‚</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(r => {
                let statusText = r.status === 'pending' ? 'å¾…å¯©æ ¸' : (r.status === 'approved' ? 'å·²æ ¸å‡†' : 'å·²é§å›');
                let startTime = new Date(r.start_time).toLocaleString('zh-TW', { hour12: false });
                let endTime = new Date(r.end_time).toLocaleString('zh-TW', { hour12: false });
                let createDate = new Date(r.created_at).toLocaleDateString();

                return `
                <tr>
                    <td>${createDate}</td>
                    ${uRole === 'admin' ? `<td>${r.user_name}</td>` : ''}
                    <td><strong>${r.leave_type}</strong></td>
                    <td><small>${startTime}<br>è‡³ ${endTime}</small></td>
                    <td>${r.request_hours} å°æ™‚</td>
                    <td><span class="status-badge ${r.status}">${statusText}</span></td>
                    <td><small>${r.reason || ''}</small></td>
                </tr>
                `;
            }).join('');
        }

        function filterData() {
            const type = document.getElementById('filter-type').value;
            const status = document.getElementById('filter-status').value;

            let filtered = allLogs;

            if (type !== 'å…¨éƒ¨') {
                filtered = filtered.filter(i => i.leave_type === type);
            }
            if (status !== 'å…¨éƒ¨') {
                filtered = filtered.filter(i => i.status === status);
            }

            renderTable(filtered);
        }
    </script>
</body>
</html>