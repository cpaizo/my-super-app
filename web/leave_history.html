<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è«‹å‡ç´€éŒ„æ˜ç´° - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1100px; margin: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-block; }
        .pending { background: #fff3e0; color: #ef6c00; }
        .approved { background: #e8f5e9; color: #2e7d32; }
        .rejected { background: #ffebee; color: #c62828; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; align-items: end; }
        table th, table td { vertical-align: middle; }
        .time-cell { font-family: monospace; font-size: 0.85rem; line-height: 1.2; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <hgroup>
                <h1>ğŸ“… è«‹å‡ç´€éŒ„æ˜ç´°</h1>
                <p>æŸ¥çœ‹æ­·å²è«‹å‡è³‡è¨Šèˆ‡å¯©æ ¸ç‹€æ…‹</p>
            </hgroup>
            <nav>
                <ul>
                    <li><button class="outline" onclick="location.href='portal.html'">è¿”å›ä¸»é¸å–®</button></li>
                </ul>
            </nav>
        </header>

        <main class="card">
            <div class="filter-grid">
                <label>å‡åˆ¥ç¯©é¸
                    <select id="filter-type" onchange="filterData()">
                        <option value="å…¨éƒ¨">å…¨éƒ¨å‡åˆ¥</option>
                        <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
                        <option value="äº‹å‡">äº‹å‡</option>
                        <option value="ç—…å‡">ç—…å‡</option>
                        <option value="å…¬å‡">å…¬å‡</option>
                    </select>
                </label>
                <label>ç‹€æ…‹ç¯©é¸
                    <select id="filter-status" onchange="filterData()">
                        <option value="å…¨éƒ¨">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="pending">å¾…å¯©æ ¸</option>
                        <option value="approved">å·²æ ¸å‡†</option>
                        <option value="rejected">å·²é§å›</option>
                    </select>
                </label>
                <div>
                    <button onclick="fetchLogs()" class="secondary">ğŸ”„ æ•´ç†æ•¸æ“š</button>
                </div>
            </div>

            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th style="width: 120px;">ç”³è«‹æ—¥æœŸ</th>
                            <th>å“¡å·¥å§“å</th>
                            <th>å‡åˆ¥</th>
                            <th style="min-width: 200px;">è«‹å‡æœŸé–“</th>
                            <th>ç¸½æ™‚æ•¸</th>
                            <th>ç‹€æ…‹</th>
                            <th>åŸå› å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody id="log-table">
                        <tr><td colspan="7" aria-busy="true">æ­£åœ¨è®€å–ç´€éŒ„...</td></tr>
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <script>
        const uEmail = localStorage.getItem('userEmail');
        const uRole = localStorage.getItem('userRole'); // admin æˆ– employee
        let allLogs = [];

        window.onload = function() {
            if (!uEmail) { window.location.href = "index.html"; return; }
            fetchLogs();
        };

        async function fetchLogs() {
            // åŸºç¤æŸ¥è©¢
            let query = _supabase.from('leave_requests').select('*').order('created_at', { ascending: false });

            // å®‰å…¨æ€§éæ¿¾ï¼šå¦‚æœä¸æ˜¯ç®¡ç†å“¡ï¼Œå¼·åˆ¶åªèƒ½çœ‹åˆ°è‡ªå·±çš„è³‡æ–™
            if (uRole !== 'admin') {
                query = query.eq('user_email', uEmail);
            }

            const { data, error } = await query;

            if (error) {
                console.error("è³‡æ–™æŠ“å–å¤±æ•—:", error);
                return;
            }

            allLogs = data;
            renderTable(allLogs);
        }

        function renderTable(list) {
            const tbody = document.getElementById('log-table');
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">ç›®å‰å°šç„¡ä»»ä½•è«‹å‡ç´€éŒ„ã€‚</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(r => {
                const statusMap = { 'pending': 'å¾…å¯©æ ¸', 'approved': 'å·²æ ¸å‡†', 'rejected': 'å·²é§å›' };
                
                // æ ¼å¼åŒ–æ—¥æœŸèˆ‡æ™‚é–“
                const createDate = new Date(r.created_at).toLocaleDateString('zh-TW');
                const startTime = new Date(r.start_time).toLocaleString('zh-TW', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false 
                });
                const endTime = new Date(r.end_time).toLocaleString('zh-TW', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false 
                });

                return `
                <tr>
                    <td>${createDate}</td>
                    <td><strong>${r.user_name || 'æœªçŸ¥'}</strong><br><small style="color:#666">${r.user_email}</small></td>
                    <td>${r.leave_type}</td>
                    <td class="time-cell">
                        èµ·ï¼š${startTime}<br>
                        è¿„ï¼š${endTime}
                    </td>
                    <td><mark>${r.request_hours} å°æ™‚</mark></td>
                    <td><span class="status-badge ${r.status}">${statusMap[r.status]}</span></td>
                    <td><small>${r.reason || '-'}</small></td>
                </tr>
                `;
            }).join('');
        }

        function filterData() {
            const type = document.getElementById('filter-type').value;
            const status = document.getElementById('filter-status').value;

            let filtered = allLogs;

            if (type !== 'å…¨éƒ¨') {
                filtered = filtered.filter(i => i.leave_type === type);
            }
            if (status !== 'å…¨éƒ¨') {
                filtered = filtered.filter(i => i.status === status);
            }

            renderTable(filtered);
        }
    </script>
</body>
</html>