<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»ç®¡å¯©æ ¸ç³»çµ± - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .status-pending { color: #f57c00; font-weight: bold; }
        .status-approved { color: #388e3c; font-weight: bold; }
        .status-rejected { color: #d32f2f; font-weight: bold; }
        table { font-size: 0.9rem; }
        .action-btns { display: flex; gap: 5px; }
        button.small { padding: 4px 8px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <hgroup>
                <h1>ğŸ“‹ å‡å–®å¯©æ ¸ç®¡ç†</h1>
                <h2>æ ¸å‡†æˆ–é§å›å“¡å·¥çš„è«‹å‡ç”³è«‹</h2>
            </hgroup>
            <nav>
                <ul>
                    <li><button class="outline" onclick="location.href='portal.html'">è¿”å›ä¸»é¸å–®</button></li>
                </ul>
            </nav>
        </header>

        <main class="card">
            <h3>â³ å¾…è™•ç†ç”³è«‹</h3>
            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th>ç”³è«‹äºº</th>
                            <th>å‡åˆ¥</th>
                            <th>æ™‚æ•¸</th>
                            <th>é–‹å§‹æ™‚é–“</th>
                            <th>çµæŸæ™‚é–“</th>
                            <th>åŸå› </th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="pending-list">
                        <tr><td colspan="7" aria-busy="true">æ­£åœ¨è¼‰å…¥ç”³è«‹è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </figure>
        </main>

        <main class="card">
            <h3>âœ… æœ€è¿‘è™•ç†ç´€éŒ„ (å‰ 10 ç­†)</h3>
            <figure>
                <table>
                    <thead>
                        <tr>
                            <th>ç”³è«‹äºº</th>
                            <th>å‡åˆ¥</th>
                            <th>æ™‚æ•¸</th>
                            <th>çµæœ</th>
                            <th>è™•ç†æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="history-list">
                        </tbody>
                </table>
            </figure>
        </main>
    </div>

    <script>
        window.onload = function() {
            loadRequests();
        };

        // 1. è¼‰å…¥æ‰€æœ‰è«‹å‡ç”³è«‹
        async function loadRequests() {
            // æŠ“å–å¾…å¯©æ ¸
            const { data: pending, error: pError } = await _supabase
                .from('leave_requests')
                .select('*')
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            // æŠ“å–å·²è™•ç†
            const { data: history, error: hError } = await _supabase
                .from('leave_requests')
                .select('*')
                .neq('status', 'pending')
                .order('created_at', { ascending: false })
                .limit(10);

            renderPending(pending);
            renderHistory(history);
        }

        // 2. æ¸²æŸ“å¾…è™•ç†åˆ—è¡¨
        function renderPending(list) {
            const tbody = document.getElementById('pending-list');
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ç”³è«‹ã€‚</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(r => `
                <tr>
                    <td><strong>${r.user_name}</strong><br><small>${r.user_email}</small></td>
                    <td>${r.leave_type}</td>
                    <td><mark>${r.request_hours}</mark></td>
                    <td>${new Date(r.start_time).toLocaleString()}</td>
                    <td>${new Date(r.end_time).toLocaleString()}</td>
                    <td>${r.reason || ''}</td>
                    <td>
                        <div class="action-btns">
                            <button class="small" onclick="processRequest(${r.id}, 'approved', '${r.user_email}', '${r.leave_type}', ${r.request_hours})">æ ¸å‡†</button>
                            <button class="small secondary outline" onclick="processRequest(${r.id}, 'rejected')">é§å›</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 3. è™•ç†æ ¸å‡†æˆ–é§å›é‚è¼¯
        async function processRequest(id, newStatus, email, type, hours) {
            if (!confirm(`ç¢ºå®šè¦å°‡æ­¤å‡å–®æ¨™è¨˜ç‚º [${newStatus === 'approved' ? 'æ ¸å‡†' : 'é§å›'}] å—ï¼Ÿ`)) return;

            // å¦‚æœæ˜¯æ ¸å‡†ï¼Œä¸”æ˜¯ã€Œç‰¹ä¼‘ã€ï¼Œå‰‡éœ€è¦å»æ›´æ–°é¡åº¦è¡¨
            if (newStatus === 'approved' && type === 'ç‰¹ä¼‘') {
                // å…ˆæŠ“å–ç›®å‰çš„å·²ç”¨æ™‚æ•¸
                const { data: quota, error: qError } = await _supabase
                    .from('leave_quotas')
                    .select('used_hours')
                    .eq('user_email', email)
                    .eq('leave_type', type)
                    .single();

                if (quota) {
                    const updatedUsedHours = quota.used_hours + hours;
                    // æ›´æ–° leave_quotas
                    await _supabase
                        .from('leave_quotas')
                        .update({ used_hours: updatedUsedHours })
                        .eq('user_email', email)
                        .eq('leave_type', type);
                }
            }

            // æ›´æ–°å‡å–®ç‹€æ…‹
            const { error } = await _supabase
                .from('leave_requests')
                .update({ status: newStatus })
                .eq('id', id);

            if (!error) {
                alert("è™•ç†å®Œæˆï¼");
                loadRequests(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            } else {
                alert("è™•ç†å¤±æ•—ï¼š" + error.message);
            }
        }

        // 4. æ¸²æŸ“æ­·å²ç´€éŒ„
        function renderHistory(list) {
            const tbody = document.getElementById('history-list');
            tbody.innerHTML = list.map(r => `
                <tr>
                    <td>${r.user_name}</td>
                    <td>${r.leave_type}</td>
                    <td>${r.request_hours} å°æ™‚</td>
                    <td><span class="status-${r.status}">${r.status === 'approved' ? 'âœ… å·²æ ¸å‡†' : 'âŒ å·²é§å›'}</span></td>
                    <td>${new Date(r.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>