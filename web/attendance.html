<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>ä¼æ¥­ç®¡ç†ç³»çµ± - å‡ºå‹¤æ‰“å¡</title>
Â  Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  Â  <script src="js/supabase.js"></script>

Â  Â  <style>
Â  Â  Â  Â  body { padding: 20px; max-width: 600px; margin: auto; background-color: #f0f2f5; }
Â  Â  Â  Â  .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
Â  Â  Â  Â  #status { font-weight: bold; margin-top: 1.5rem; text-align: center; min-height: 3em; }
Â  Â  Â  Â  .clock-display { font-size: 2.8rem; font-weight: bold; text-align: center; margin-bottom: 0.2rem; color: #1a1a1a; }
Â  Â  Â  Â  .date-display { text-align: center; color: #777; margin-bottom: 2rem; letter-spacing: 1px; }
Â  Â  Â  Â  button { width: 100%; margin-bottom: 1rem; font-size: 1.1rem; transition: 0.3s; }
Â  Â  Â  Â  button:disabled { cursor: not-allowed; opacity: 0.7; }
Â  Â  Â  Â  .location-info { font-size: 0.85rem; color: #888; text-align: center; margin-top: 1rem; background: #f9f9f9; padding: 10px; border-radius: 8px; }
Â  Â  </style>
</head>
<body>
Â  Â  <main class="container">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <div class="clock-display" id="clock">00:00:00</div>
Â  Â  Â  Â  Â  Â  <div class="date-display" id="date-info">----å¹´--æœˆ--æ—¥</div>

Â  Â  Â  Â  Â  Â  <h3 id="welcome-msg" style="text-align:center;">è¼‰å…¥ä¸­...</h3>
Â  Â  Â  Â  Â  Â  <p style="text-align:center;">ç•¶å‰èº«åˆ†ï¼š<mark id="user-role">---</mark></p>
Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div id="check-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-in" onclick="handleCheckIn('check_in')">ğŸŒ ä¸Šç­æ‰“å¡</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-out" class="secondary" onclick="handleCheckIn('check_out')">ğŸŒœ ä¸‹ç­æ‰“å¡</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="status">æ­£åœ¨åŒæ­¥ç³»çµ±è³‡è¨Š...</div>

Â  Â  Â  Â  Â  Â  <div class="location-info" id="gps-detail">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>[ å®šä½è³‡è¨Š ]</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  ç›®å‰ä½ç½®ï¼š<span id="coord-val">å°šæœªå–å¾—</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  è·é›¢ä¸­å¿ƒï¼š<span id="dist-val">--</span> å…¬å°º
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </main>

Â  Â  <script>
Â  Â  Â  Â  // å…¨åŸŸè®Šæ•¸
Â  Â  Â  Â  let OFFICE_CONFIG = { lat: 0, lng: 0, radius: 200 };
Â  Â  Â  Â  const uInfo = {
Â  Â  Â  Â  Â  Â  name: localStorage.getItem('userName'),
Â  Â  Â  Â  Â  Â  email: localStorage.getItem('userEmail'),
Â  Â  Â  Â  Â  Â  role: localStorage.getItem('userRole')
Â  Â  Â  Â  };

Â  Â  Â  Â  // 1. æ›´æ–°æ™‚é˜
Â  Â  Â  Â  function updateClock() {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const twTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
Â  Â  Â  Â  Â  Â  document.getElementById('clock').innerText = twTime.toLocaleTimeString('zh-TW', { hour12: false });
Â  Â  Â  Â  Â  Â  document.getElementById('date-info').innerText = `${twTime.getFullYear()}å¹´${twTime.getMonth()+1}æœˆ${twTime.getDate()}æ—¥`;
Â  Â  Â  Â  }
Â  Â  Â  Â  setInterval(updateClock, 1000);

Â  Â  Â  Â  // 2. åˆå§‹åŒ–æµç¨‹
Â  Â  Â  Â  window.onload = async function() {
Â  Â  Â  Â  Â  Â  if (!uInfo.email) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥");
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "index.html";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('welcome-msg').innerText = `ä½ å¥½ï¼Œ${uInfo.name}`;
Â  Â  Â  Â  Â  Â  document.getElementById('user-role').innerText = uInfo.role;
Â  Â  Â  Â  Â  Â  updateClock();

Â  Â  Â  Â  Â  Â  // åŒæ­¥åŸ·è¡Œï¼šè¼‰å…¥åº§æ¨™èˆ‡æª¢æŸ¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹
Â  Â  Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  loadOfficeConfig(),
Â  Â  Â  Â  Â  Â  Â  Â  checkTodayStatus()
Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  };

Â  Â  Â  Â  // 3. è¼‰å…¥è¾¦å…¬å®¤åº§æ¨™è¨­å®š
Â  Â  Â  Â  async function loadOfficeConfig() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await _supabase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('system_config')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('latitude, longitude, radius')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('config_name', 'office_location')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .single();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (data && !error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  OFFICE_CONFIG.lat = data.latitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  OFFICE_CONFIG.lng = data.longitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  OFFICE_CONFIG.radius = data.radius;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('status').innerText = "ğŸ“ GPS å®šä½ç³»çµ±å°±ç·’";
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('status').innerText = "âŒ ç„¡æ³•è®€å–ä¸­å¿ƒåº§æ¨™";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('status').innerText = "âŒ ç¶²è·¯é€£ç·šç•°å¸¸";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. æª¢æŸ¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹ (é˜²é‡è¤‡æ‰“å¡)
Â  Â  Â  Â  async function checkTodayStatus() {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  // å–å¾—ä»Šæ—¥å°ç£æ™‚é–“ 00:00:00 çš„ ISO å­—ä¸²
Â  Â  Â  Â  Â  Â  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();

Â  Â  Â  Â  Â  Â  const { data, error } = await _supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('attendance_logs')
Â  Â  Â  Â  Â  Â  Â  Â  .select('type')
Â  Â  Â  Â  Â  Â  Â  Â  .eq('user_email', uInfo.email)
Â  Â  Â  Â  Â  Â  Â  Â  .gte('created_at', todayStart);

Â  Â  Â  Â  Â  Â  if (data && !error) {
Â  Â  Â  Â  Â  Â  Â  Â  data.forEach(log => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log.type === 'check_in') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.getElementById('btn-in');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "âœ… ä»Šæ—¥ä¸Šç­å·²æ‰“å¡";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log.type === 'check_out') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.getElementById('btn-out');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "âœ… ä»Šæ—¥ä¸‹ç­å·²æ‰“å¡";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // 5. è·é›¢è¨ˆç®—
Â  Â  Â  Â  function calculateDistance(lat1, lon1, lat2, lon2) {
Â  Â  Â  Â  Â  Â  const R = 6371;
Â  Â  Â  Â  Â  Â  const dLat = (lat2 - lat1) * Math.PI / 180;
Â  Â  Â  Â  Â  Â  const dLon = (lon2 - lon1) * Math.PI / 180;
Â  Â  Â  Â  Â  Â  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Math.sin(dLon / 2) * Math.sin(dLon / 2);
Â  Â  Â  Â  Â  Â  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
Â  Â  Â  Â  Â  Â  return Math.round(R * c * 1000);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 6. åŸ·è¡Œæ‰“å¡
Â  Â  Â  Â  async function handleCheckIn(actionType) {
Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('status');
Â  Â  Â  Â  Â  Â  const btnIn = document.getElementById('btn-in');
Â  Â  Â  Â  Â  Â  const btnOut = document.getElementById('btn-out');

Â  Â  Â  Â  Â  Â  if (OFFICE_CONFIG.lat === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("å°šæœªç²å–è¨­å®šå€¼ï¼Œè«‹ç¨å¾Œå†è©¦");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `<span aria-busy="true">æ­£åœ¨å–å¾— GPS ä½ç½®...</span>`;
Â  Â  Â  Â  Â  Â  btnIn.disabled = true;
Â  Â  Â  Â  Â  Â  btnOut.disabled = true;

Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  Â  Â  async (pos) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uLat = pos.coords.latitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uLng = pos.coords.longitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dist = calculateDistance(uLat, uLng, OFFICE_CONFIG.lat, OFFICE_CONFIG.lng);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('coord-val').innerText = `${uLat.toFixed(6)}, ${uLng.toFixed(6)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('dist-val').innerText = dist;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dist > OFFICE_CONFIG.radius) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `<span style="color:red">âŒ è·é›¢éé  (${dist}m)</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // é‡æ–°æª¢æŸ¥ç‹€æ…‹ä»¥æ±ºå®šæ˜¯å¦æ¢å¾©æŒ‰éˆ•
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await checkTodayStatus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¦‚æœæª¢æŸ¥å®ŒæŒ‰éˆ•æ²’è¢«é–ä½ï¼Œæ‰æ¢å¾©é»æ“Š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionType === 'check_in' && !document.getElementById('btn-in').innerText.includes('å·²æ‰“å¡')) btnIn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionType === 'check_out' && !document.getElementById('btn-out').innerText.includes('å·²æ‰“å¡')) btnOut.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerText = "ğŸ“ ç¯„åœæ ¸å°æˆåŠŸï¼Œå„²å­˜ä¸­...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await submitAttendance(uLat, uLng, actionType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  (err) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `<span style="color:red">å®šä½å¤±æ•—ï¼Œè«‹é–‹å•Ÿå®šä½æ¬Šé™</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkTodayStatus(); 
Â  Â  Â  Â  Â  Â  Â  Â  }, 
Â  Â  Â  Â  Â  Â  Â  Â  { enableHighAccuracy: false, timeout: 10000 }
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  }

Â  Â  Â  Â  // 7. å¯«å…¥ç´€éŒ„
Â  Â  Â  Â  async function submitAttendance(lat, lng, type) {
Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('status');
Â  Â  Â  Â  Â  Â  const dist = calculateDistance(lat, lng, OFFICE_CONFIG.lat, OFFICE_CONFIG.lng);

Â  Â  Â  Â  Â  Â  const { error } = await _supabase.from('attendance_logs').insert([{
Â  Â  Â  Â  Â  Â  Â  Â  user_email: uInfo.email,
Â  Â  Â  Â  Â  Â  Â  Â  user_name: uInfo.name,
Â  Â  Â  Â  Â  Â  Â  Â  type: type,
Â  Â  Â  Â  Â  Â  Â  Â  latitude: lat,
Â  Â  Â  Â  Â  Â  Â  Â  longitude: lng,
Â  Â  Â  Â  Â  Â  Â  Â  distance: dist,
Â  Â  Â  Â  Â  Â  Â  Â  is_within_range: true,
Â  Â  Â  Â  Â  Â  Â  Â  device_info: navigator.userAgent
Â  Â  Â  Â  Â  Â  }]);

Â  Â  Â  Â  Â  Â  if (!error) {
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `<span style="color:green">âœ… æ‰“å¡ç´€éŒ„å·²å„²å­˜ï¼</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { window.location.href = "portal.html"; }, 1500);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("ç³»çµ±éŒ¯èª¤ï¼š" + error.message);
Â  Â  Â  Â  Â  Â  Â  Â  location.reload(); // å¤±æ•—å‰‡é‡æ–°æ•´ç†æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>