<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­ç®¡ç†ç³»çµ± - å‡ºå‹¤æ‰“å¡</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>

    <style>
        body { padding: 20px; max-width: 600px; margin: auto; background-color: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        #status { font-weight: bold; margin-top: 1.5rem; text-align: center; min-height: 3em; }
        .clock-display { font-size: 2.8rem; font-weight: bold; text-align: center; margin-bottom: 0.2rem; color: #1a1a1a; }
        .date-display { text-align: center; color: #777; margin-bottom: 2rem; letter-spacing: 1px; }
        button { width: 100%; margin-bottom: 1rem; font-size: 1.1rem; }
        .location-info { font-size: 0.85rem; color: #888; text-align: center; margin-top: 1rem; }
    </style>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="clock-display" id="clock">00:00:00</div>
            <div class="date-display" id="date-info">----å¹´--æœˆ--æ—¥</div>

            <h3 id="welcome-msg" style="text-align:center;">æ­£åœ¨è®€å–èº«åˆ†...</h3>
            <p style="text-align:center;">ç•¶å‰èº«åˆ†ï¼š<mark id="user-role">---</mark></p>
            <hr>
            
            <div id="check-buttons">
                <button id="btn-in" onclick="handleCheckIn('check_in')">ğŸŒ ä¸Šç­æ‰“å¡</button>
                <button id="btn-out" class="secondary" onclick="handleCheckIn('check_out')">ğŸŒœ ä¸‹ç­æ‰“å¡</button>
            </div>

            <div id="status">æ­£åœ¨åˆå§‹åŒ–å®šä½ç³»çµ±...</div>

            <div class="location-info" id="gps-detail" style="display:none;">
                ç›®å‰ç¶“ç·¯ï¼š<span id="coord-val">--</span><br>
                è·é›¢ä¸­å¿ƒï¼š<span id="dist-val">--</span> å…¬å°º
            </div>
        </div>
    </main>

    <script>
        // è®Šæ•¸åˆå§‹åŒ–
        let OFFICE_CONFIG = { lat: 0, lng: 0, radius: 200 };
        const uInfo = {
            name: localStorage.getItem('userName'),
            email: localStorage.getItem('userEmail'),
            role: localStorage.getItem('userRole')
        };

        // 1. æ›´æ–°æ™‚é˜é‚è¼¯
        function updateClock() {
            const now = new Date();
            const twTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
            document.getElementById('clock').innerText = twTime.toLocaleTimeString('zh-TW', { hour12: false });
            document.getElementById('date-info').innerText = `${twTime.getFullYear()}å¹´${twTime.getMonth()+1}æœˆ${twTime.getDate()}æ—¥`;
        }
        setInterval(updateClock, 1000);

        // 2. ç¶²é è¼‰å…¥è®€å–è¨­å®š
        window.onload = async function() {
            if (!uInfo.email) {
                alert("ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥");
                window.location.href = "index.html";
                return;
            }

            document.getElementById('welcome-msg').innerText = `ä½ å¥½ï¼Œ${uInfo.name}`;
            document.getElementById('user-role').innerText = uInfo.role;

            try {
                // å¾ Supabase æŠ“å–è¾¦å…¬å®¤åº§æ¨™
                const { data, error } = await _supabase
                    .from('system_config')
                    .select('value_json')
                    .eq('key', 'office_location')
                    .single();
                
                if (data) {
                    OFFICE_CONFIG = data.value_json;
                    document.getElementById('status').innerHTML = "ğŸ“ GPS å®šä½å·²å°±ç·’<br><small>è«‹ç¢ºèªå·²é–‹å•Ÿ Wi-Fi ä»¥åˆ©å®šä½</small>";
                }
            } catch (e) {
                document.getElementById('status').innerText = "âŒ ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨è¨­å®š";
            }
        };

        // 3. è·é›¢è¨ˆç®— (Haversine å…¬å¼)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return Math.round(R * c * 1000); // è½‰æ›ç‚ºå…¬å°º
        }

        // 4. æ‰“å¡è™•ç†é‚è¼¯
        async function handleCheckIn(actionType) {
            const statusEl = document.getElementById('status');
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');

            statusEl.innerHTML = `<span aria-busy="true">æ­£åœ¨ç²å–çœŸå¯¦ GPS ä½ç½®...</span>`;
            btnIn.disabled = true;
            btnOut.disabled = true;

            // é‡å°ç­†é›»å„ªåŒ–çš„å®šä½åƒæ•¸ï¼šå…ˆå˜—è©¦é«˜ç²¾åº¦ï¼Œå¤±æ•—å¾Œé™ç´š
            const geoOptions = {
                enableHighAccuracy: true, 
                timeout: 10000,           
                maximumAge: 0             
            };

            if (!navigator.geolocation) {
                statusEl.innerText = "âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const uLat = pos.coords.latitude;
                    const uLng = pos.coords.longitude;
                    
                    const dist = calculateDistance(uLat, uLng, OFFICE_CONFIG.lat, OFFICE_CONFIG.lng);
                    
                    // é¡¯ç¤ºåµéŒ¯è³‡è¨Š
                    document.getElementById('gps-detail').style.display = "block";
                    document.getElementById('coord-val').innerText = `${uLat.toFixed(4)}, ${uLng.toFixed(4)}`;
                    document.getElementById('dist-val').innerText = dist;

                    if (dist > OFFICE_CONFIG.radius) {
                        statusEl.innerHTML = `<span style="color:red">âŒ è·é›¢å…¬å¸éé  (${dist}m)</span><br><small>æ‰“å¡åŠå¾‘é™åˆ¶ï¼š${OFFICE_CONFIG.radius}m</small>`;
                        btnIn.disabled = false;
                        btnOut.disabled = false;
                    } else {
                        statusEl.innerText = "ğŸ“ ç¯„åœç¢ºèªæˆåŠŸï¼ä¸Šå‚³è³‡æ–™ä¸­...";
                        await submitAttendance(uLat, uLng, actionType);
                    }
                },
                (err) => {
                    // å¦‚æœé«˜ç²¾åº¦å¤±æ•—ï¼Œå˜—è©¦ä½ç²¾åº¦ (Wi-Fi æ¨¡å¼)
                    if (geoOptions.enableHighAccuracy) {
                        statusEl.innerText = "å˜—è©¦å‚™ç”¨å®šä½æ¨¡å¼ä¸­...";
                        geoOptions.enableHighAccuracy = false;
                        navigator.geolocation.getCurrentPosition(arguments.callee, handleGeoError, geoOptions);
                    } else {
                        handleGeoError(err);
                    }
                }, 
                geoOptions
            );
        }

        function handleGeoError(err) {
            const statusEl = document.getElementById('status');
            let msg = "å®šä½å¤±æ•—ï¼š";
            if (err.code === 1) msg += "æ¬Šé™è¢«æ‹’çµ•";
            else if (err.code === 2) msg += "ç„¡æ³•åµæ¸¬ä½ç½® (è«‹ç¢ºèª Wi-Fi å·²é–‹å•Ÿ)";
            else if (err.code === 3) msg += "å®šä½é€¾æ™‚";
            statusEl.innerHTML = `<span style="color:red">${msg}</span>`;
            document.getElementById('btn-in').disabled = false;
            document.getElementById('btn-out').disabled = false;
        }

        // 5. å¯«å…¥è³‡æ–™åº«
        async function submitAttendance(lat, lng, type) {
            const { error } = await _supabase.from('attendance_logs').insert([{
                user_email: uInfo.email,
                user_name: uInfo.name,
                type: type,
                latitude: lat,
                longitude: lng,
                is_within_range: true,
                device_info: navigator.userAgent
            }]);

            if (!error) {
                document.getElementById('status').innerHTML = `<span style="color:green">âœ… æ‰“å¡æˆåŠŸï¼</span>`;
                setTimeout(() => { window.location.href = "dashboard.html"; }, 1500);
            } else {
                alert("è³‡æ–™åº«å¯«å…¥å¤±æ•—ï¼š" + error.message);
                document.getElementById('btn-in').disabled = false;
                document.getElementById('btn-out').disabled = false;
            }
        }
    </script>
</body>
</html>