<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­ç®¡ç†ç³»çµ± - å‡ºå‹¤æ‰“å¡</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>

    <style>
        body { padding: 20px; max-width: 600px; margin: auto; background-color: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .hidden { display: none; }
        #status { font-weight: bold; margin-top: 1rem; text-align: center; }
        .clock-display { font-size: 2.5rem; font-weight: bold; text-align: center; margin-bottom: 0.5rem; }
        .date-display { text-align: center; color: #666; margin-bottom: 2rem; }
    </style>
</head>
<body>
    <main class="container">
        <div class="card">
            <div class="clock-display" id="clock">00:00:00</div>
            <div class="date-display" id="date-info">----å¹´--æœˆ--æ—¥</div>

            <h3 id="welcome-msg" style="text-align:center;">æ­£åœ¨é©—è­‰èº«åˆ†...</h3>
            <p style="text-align:center;">ç•¶å‰èº«åˆ†ï¼š<mark id="user-role">---</mark></p>
            <hr>
            
            <div id="check-buttons">
                <button id="btn-in" onclick="handleCheckIn('check_in')">ğŸŒ ä¸Šç­æ‰“å¡</button>
                <button id="btn-out" class="secondary" onclick="handleCheckIn('check_out')">ğŸŒœ ä¸‹ç­æ‰“å¡</button>
            </div>

            <p id="status">æ­£åœ¨ç²å–å®šä½è³‡è¨Š...</p>
        </div>
    </main>

    <script>
        // å¾è³‡æ–™åº«æŠ“å–çš„å…¬å¸é…ç½® (ç¨å¾Œç”± onload æ›´æ–°)
        let OFFICE_CONFIG = { lat: 0, lng: 0, radius: 200 };
        
        // å¾ localStorage å–å¾—ç™»å…¥è³‡è¨Š (ç”± index.html å­˜å…¥)
        const uInfo = {
            name: localStorage.getItem('userName'),
            email: localStorage.getItem('userEmail'),
            role: localStorage.getItem('userRole')
        };

        // --- 1. åˆå§‹åŒ–èˆ‡æ™‚é–“é¡¯ç¤º ---
        function updateClock() {
            const now = new Date();
            const twTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
            document.getElementById('clock').innerText = twTime.toLocaleTimeString('zh-TW', { hour12: false });
            document.getElementById('date-info').innerText = `${twTime.getFullYear()}å¹´${twTime.getMonth()+1}æœˆ${twTime.getDate()}æ—¥`;
        }
        setInterval(updateClock, 1000);

        window.onload = async function() {
            // é©—è­‰æ˜¯å¦æœ‰ç™»å…¥è³‡è¨Š
            if (!uInfo.email) {
                alert("è«‹å…ˆç™»å…¥ï¼");
                window.location.href = "index.html";
                return;
            }

            // æ›´æ–° UI
            document.getElementById('welcome-msg').innerText = `ä½ å¥½ï¼Œ${uInfo.name}`;
            document.getElementById('user-role').innerText = uInfo.role;

            // å¾ Supabase æŠ“å–è¾¦å…¬å®¤åº§æ¨™è¨­å®š
            try {
                const { data, error } = await _supabase
                    .from('system_config')
                    .select('value_json')
                    .eq('key', 'office_location')
                    .single();
                
                if (data) {
                    OFFICE_CONFIG = data.value_json;
                    document.getElementById('status').innerText = "ğŸ“ å®šä½ç³»çµ±æº–å‚™å°±ç·’";
                }
            } catch (e) {
                document.getElementById('status').innerText = "âŒ ç„¡æ³•è®€å–å…¬å¸åº§æ¨™é…ç½®";
            }
        };

        // --- 2. è·é›¢è¨ˆç®—å‡½æ•¸ (Haversine å…¬å¼) ---
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // å…¬é‡Œ
        }

        // --- 3. æ ¸å¿ƒæ‰“å¡é‚è¼¯ ---
        async function handleCheckIn(actionType) {
            const status = document.getElementById('status');
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');

            status.innerText = `æ­£åœ¨ç¢ºèªæ‚¨çš„ä½ç½®èˆ‡è·é›¢...`;
            
            // é–å®šæŒ‰éˆ•é˜²æ­¢é€£é»
            btnIn.disabled = true;
            btnOut.disabled = true;

            // ä½¿ç”¨é«˜ç²¾åº¦å®šä½åƒæ•¸ (å°ç­†é›»å®šä½æ¥µå…¶é‡è¦)
            const geoOptions = {
                enableHighAccuracy: true, 
                timeout: 10000,           
                maximumAge: 0             
            };

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const userLat = pos.coords.latitude;
                const userLng = pos.coords.longitude;
                
                // è¨ˆç®—è·é›¢ (å…¬é‡Œ)
                const distance = getDistance(userLat, userLng, OFFICE_CONFIG.lat, OFFICE_CONFIG.lng);
                const distanceMeter = Math.round(distance * 1000);
                const maxKm = OFFICE_CONFIG.radius / 1000; // å°‡å…¬å°ºè½‰ç‚ºå…¬é‡Œåšåˆ¤æ–·

                // åˆ¤æ–·æ˜¯å¦åœ¨ç¯„åœå…§
                if (distance > maxKm) {
                    status.innerHTML = `<span style="color:red">âŒ æ‰“å¡å¤±æ•—ï¼<br>è·é›¢è¾¦å…¬å®¤ ${distanceMeter}mï¼Œè¶…å‡º ${OFFICE_CONFIG.radius}m é™åˆ¶ã€‚</span>`;
                    btnIn.disabled = false;
                    btnOut.disabled = false;
                    return;
                }

                status.innerText = `å®šä½ç¬¦åˆï¼æ­£åœ¨å°‡è³‡æ–™å¯«å…¥ Supabase...`;

                // å¯«å…¥ Supabase è³‡æ–™è¡¨ attendance_logs
                const { error } = await _supabase.from('attendance_logs').insert([{
                    user_email: uInfo.email,
                    user_name: uInfo.name,
                    type: actionType,
                    latitude: userLat,
                    longitude: userLng,
                    is_within_range: true,
                    device_info: navigator.userAgent
                }]);

                if (!error) {
                    status.innerHTML = `<span style="color:green">âœ… æ‰“å¡æˆåŠŸï¼<br>è·é›¢å…¬å¸ï¼š${distanceMeter} å…¬å°º</span>`;
                    alert("æ‰“å¡æˆåŠŸï¼å³å°‡å‰å¾€è¨‚é¤é é¢ã€‚");
                    window.location.href = "dashboard.html";
                } else {
                    status.innerHTML = `<span style="color:red">âŒ å¯«å…¥å¤±æ•—ï¼š${error.message}</span>`;
                    btnIn.disabled = false;
                    btnOut.disabled = false;
                }

            }, (err) => {
                status.innerText = "âŒ å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèªå·²é–‹å•Ÿ GPS/Wi-Fi å®šä½æ¬Šé™ã€‚";
                btnIn.disabled = false;
                btnOut.disabled = false;
            }, geoOptions);
        }
    </script>
</body>
</html>