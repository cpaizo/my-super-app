<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­ç®¡ç†ç³»çµ± - å‡ºå‹¤æ‰“å¡</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>

    <style>
        :root {
            --primary-color: #4a90e2; --secondary-color: #67c23a;
            --danger-color: #e74c3c; --bg-color: #f4f7f6;
        }
        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background: var(--bg-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        
        .time-display { font-size: 42px; font-weight: bold; color: #333; font-family: monospace; margin-bottom: 5px; }
        .date-display { color: #888; margin-bottom: 30px; letter-spacing: 1px; }

        .status-box { padding: 15px; border-radius: 12px; margin-bottom: 25px; transition: 0.3s; }
        .in-range { background: #eaffea; color: #27ae60; border: 1px solid #c3e6cb; }
        .out-range { background: #ffeaea; color: #e74c3c; border: 1px solid #f5c6cb; }
        
        .btn-group { display: flex; flex-direction: column; gap: 15px; }
        .btn-check { padding: 18px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-in { background: var(--primary-color); }
        .btn-out { background: var(--secondary-color); }
        .btn-check:active { transform: scale(0.98); }
        .btn-check:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        #distance-info { font-size: 13px; color: #999; margin-top: 15px; line-height: 1.5; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; width: 20px; height: 20px; display: inline-block; animation: spin 1s linear infinite; vertical-align: middle; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <div class="time-display" id="clock">00:00:00</div>
    <div class="date-display" id="date-info">----å¹´--æœˆ--æ—¥</div>

    <div id="status-container" class="status-box out-range">
        <span id="status-text">æ­£åœ¨è®€å–å®šä½è³‡è¨Š...</span>
    </div>

    <div class="btn-group">
        <button id="btn-in" class="btn-check btn-in" onclick="doAction('check_in')" disabled>â˜€ï¸ ä¸Šç­æ‰“å¡</button>
        <button id="btn-out" class="btn-check btn-out" onclick="doAction('check_out')" disabled>ğŸŒ™ ä¸‹ç­æ‰“å¡</button>
    </div>

    <div id="distance-info">
        <div id="gps-loading"><div class="loading-spinner"></div> GPS å®šä½ä¸­å¿ƒé»æ ¡å°ä¸­...</div>
        <div id="location-detail" style="display:none;">
            ç›®å‰è·é›¢å…¬å¸ï¼š<span id="dist-val">---</span> å…¬å°º<br>
            åº§æ¨™ï¼š<span id="coord-val">---</span>
        </div>
    </div>
</div>

<script>
    let officeConfig = { lat: 0, lng: 0, radius: 200 };
    let userPos = { lat: 0, lng: 0 };
    const uInfo = {
        name: localStorage.getItem('userName'),
        email: localStorage.getItem('userEmail')
    };

    // 1. åˆå§‹åŒ–ï¼šæ›´æ–°æ™‚é˜èˆ‡è®€å–è¨­å®š
    function updateClock() {
        const now = new Date();
        const twTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
        document.getElementById('clock').innerText = twTime.toLocaleTimeString('zh-TW', { hour12: false });
        document.getElementById('date-info').innerText = `${twTime.getFullYear()}å¹´${twTime.getMonth()+1}æœˆ${twTime.getDate()}æ—¥`;
    }
    setInterval(updateClock, 1000);

    window.onload = async function() {
        if (!uInfo.email) { window.location.href = "index.html"; return; }
        
        // å¾ Supabase æŠ“å–è¾¦å…¬å®¤åº§æ¨™
        const { data, error } = await _supabase.from('system_config').select('value_json').eq('key', 'office_location').single();
        if (data) {
            officeConfig = data.value_json;
            startTracking();
        } else {
            alert("ç„¡æ³•è®€å–å…¬å¸åº§æ¨™è¨­å®šï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚");
        }
    };

    // 2. GPS è¿½è¹¤èˆ‡è·é›¢è¨ˆç®—
    function startTracking() {
        if (!navigator.geolocation) {
            updateStatus("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ GPS å®šä½", false);
            return;
        }

        navigator.geolocation.watchPosition(
            (pos) => {
                userPos.lat = pos.coords.latitude;
                userPos.lng = pos.coords.longitude;
                
                const distance = calculateDistance(userPos.lat, userPos.lng, officeConfig.lat, officeConfig.lng);
                updateUI(distance);
            },
            (err) => {
                updateStatus("å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèªé–‹å•Ÿ GPS æ¬Šé™", false);
            },
            { enableHighAccuracy: true }
        );
    }

    // å“ˆå¼—è¾›å…¬å¼è¨ˆç®—è·é›¢ (å…¬å°º)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // åœ°çƒåŠå¾‘ (å…¬å°º)
        const Ï†1 = lat1 * Math.PI/180;
        const Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180;
        const Î”Î» = (lon2-lon1) * Math.PI/180;

        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return Math.round(R * c);
    }

    // 3. UI æ›´æ–°é‚è¼¯
    function updateUI(dist) {
        document.getElementById('gps-loading').style.display = "none";
        document.getElementById('location-detail').style.display = "block";
        document.getElementById('dist-val').innerText = dist;
        document.getElementById('coord-val').innerText = `${userPos.lat.toFixed(4)}, ${userPos.lng.toFixed(4)}`;

        const isInRange = dist <= officeConfig.radius;
        if (isInRange) {
            updateStatus("ğŸ“ æ‚¨å·²é€²å…¥æ‰“å¡ç¯„åœ", true);
            document.getElementById('btn-in').disabled = false;
            document.getElementById('btn-out').disabled = false;
        } else {
            updateStatus(`âŒ è·é›¢å…¬å¸éé  (${dist}m)`, false);
            document.getElementById('btn-in').disabled = true;
            document.getElementById('btn-out').disabled = true;
        }
    }

    function updateStatus(text, ok) {
        const el = document.getElementById('status-container');
        el.className = `status-box ${ok ? 'in-range' : 'out-range'}`;
        document.getElementById('status-text').innerText = text;
    }

    // 4. æ‰“å¡åŸ·è¡Œ
    async function doAction(type) {
        if (!confirm(`ç¢ºå®šè¦è¾¦ç†${type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­'}æ‰“å¡å—ï¼Ÿ`)) return;

        // é€£é»ä¿è­·
        document.getElementById('btn-in').disabled = true;
        document.getElementById('btn-out').disabled = true;

        const { error } = await _supabase.from('attendance_logs').insert([{
            user_email: uInfo.email,
            user_name: uInfo.name,
            type: type,
            latitude: userPos.lat,
            longitude: userPos.lng,
            is_within_range: true,
            device_info: navigator.userAgent
        }]);

        if (!error) {
            alert("æ‰“å¡æˆåŠŸï¼");
            // æ‰“å¡æˆåŠŸå¾Œå¯é¸æ“‡è·³è½‰åˆ°é»é¤é é¢
            window.location.href = "dashboard.html";
        } else {
            alert("æ‰“å¡å¤±æ•—ï¼š" + error.message);
            location.reload();
        }
    }
</script>

</body>
</html>