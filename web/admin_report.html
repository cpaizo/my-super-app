<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è€ƒå‹¤ç›£æ§ - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-box { padding: 1.5rem; border-radius: 12px; text-align: center; color: white; }
        .bg-blue { background-color: #3949ab; }
        .bg-green { background-color: #43a047; }
        .bg-orange { background-color: #fb8c00; }
        .bg-red { background-color: #e53935; }
        .status-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; border: 1px solid; }
        .on-duty { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
        .off-duty { background: #ffebee; color: #c62828; border-color: #c62828; }
        .on-leave { background: #fff3e0; color: #ef6c00; border-color: #ef6c00; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <hgroup>
                <h1>ğŸ“Š å…¨å“¡å³æ™‚è€ƒå‹¤ç›£æ§</h1>
                <p id="today-date">æ•¸æ“šåŒæ­¥ä¸­...</p>
            </hgroup>
            <button class="outline" onclick="location.href='portal.html'">è¿”å›ä¸»é¸å–®</button>
        </header>

        <div class="stat-grid">
            <div class="stat-box bg-blue">
                <small>æ­£å¼å“¡å·¥ç¸½æ•¸</small>
                <h2 id="total-staff">0</h2>
            </div>
            <div class="stat-box bg-green">
                <small>ä»Šæ—¥å·²æ‰“å¡</small>
                <h2 id="present-count">0</h2>
            </div>
            <div class="stat-box bg-orange">
                <small>æ ¸å‡†è«‹å‡ä¸­</small>
                <h2 id="leave-count">0</h2>
            </div>
            <div class="stat-box bg-red">
                <small>ç¼ºå¸­æœªæ‰“å¡</small>
                <h2 id="absent-count">0</h2>
            </div>
        </div>

        <main class="card">
            <h3>ğŸ‘¥ å“¡å·¥ç‹€æ…‹æ˜ç´°</h3>
            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th>å“¡å·¥å§“å</th>
                            <th>ç›®å‰ç‹€æ…‹</th>
                            <th>ä¸Šç­æ‰“å¡ (In)</th>
                            <th>ä¸‹ç­æ‰“å¡ (Out)</th>
                            <th>ä»Šæ—¥å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list">
                        <tr><td colspan="5" aria-busy="true" style="text-align:center;">æ­£åœ¨è¼‰å…¥æ­£å¼å“¡å·¥åå–®...</td></tr>
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <script>
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];

        window.onload = async function() {
            document.getElementById('today-date').innerText = "æŸ¥è©¢æ—¥æœŸï¼š" + new Date().toLocaleDateString();
            await fetchMonitorData();
        };

        async function fetchMonitorData() {
            const listBody = document.getElementById('attendance-list');
            try {
                // 1. æŠ“å–æ‰€æœ‰æ­£å¼å“¡å·¥ (full_name)
                const { data: staff, error: sError } = await _supabase
                    .from('employees')
                    .select('full_name, email');
                if (sError) throw sError;

                // 2. æŠ“å–ä»Šæ—¥æ‰“å¡ç´€éŒ„ (created_at ç¯©é¸ä»Šå¤©)
                const { data: logs, error: lError } = await _supabase
                    .from('attendance_logs')
                    .select('user_email, created_at, type')
                    .gte('created_at', todayStr + 'T00:00:00')
                    .lte('created_at', todayStr + 'T23:59:59');
                if (lError) throw lError;

                // 3. æŠ“å–ä»Šæ—¥è«‹å‡
                const { data: leaves, error: lvError } = await _supabase
                    .from('leave_requests')
                    .select('*')
                    .eq('status', 'approved');

                renderMonitor(staff || [], logs || [], leaves || []);
            } catch (err) {
                console.error("è¼‰å…¥éŒ¯èª¤:", err);
                listBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">âš ï¸ éŒ¯èª¤: ${err.message}</td></tr>`;
            }
        }

        function renderMonitor(staff, logs, leaves) {
            const tbody = document.getElementById('attendance-list');
            let presentCount = 0;
            let leaveCount = 0;

            // è™•ç†æ‰“å¡ç´€éŒ„ï¼šæŒ‰ email å­˜å„² check_in å’Œ check_out
            const punchData = {};
            logs.forEach(log => {
                const email = log.user_email;
                const time = new Date(log.created_at).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });
                
                if (!punchData[email]) {
                    punchData[email] = { check_in: '---', check_out: '---' };
                }

                if (log.type === 'check_in') {
                    // å¦‚æœåŒä¸€å€‹äººå¤šæ¬¡ check_inï¼Œå–æœ€æ—©çš„
                    if (punchData[email].check_in === '---' || time < punchData[email].check_in) {
                        punchData[email].check_in = time;
                    }
                } else if (log.type === 'check_out') {
                    // å¦‚æœåŒä¸€å€‹äººå¤šæ¬¡ check_outï¼Œå–æœ€æ™šçš„
                    if (punchData[email].check_out === '---' || time > punchData[email].check_out) {
                        punchData[email].check_out = time;
                    }
                }
            });

            tbody.innerHTML = staff.map(user => {
                const record = punchData[user.email];
                const nowTime = new Date();
                
                // è«‹å‡åˆ¤æ–·
                const activeLeave = leaves.find(l => 
                    l.user_email === user.email && 
                    nowTime >= new Date(l.start_time) && 
                    nowTime <= new Date(l.end_time)
                );

                let statusHtml = "";
                let inTime = record ? record.check_in : '---';
                let outTime = record ? record.check_out : '---';
                let note = "";

                if (activeLeave) {
                    statusHtml = '<span class="status-tag on-leave">è«‹å‡ä¸­</span>';
                    note = `[${activeLeave.leave_type}] ${activeLeave.reason || ''}`;
                    leaveCount++;
                } else if (record && record.check_in !== '---') {
                    statusHtml = '<span class="status-tag on-duty">å·²åˆ°å·¥</span>';
                    presentCount++;
                } else {
                    statusHtml = '<span class="status-tag off-duty">æœªæ‰“å¡</span>';
                }

                return `
                    <tr>
                        <td><strong>${user.full_name}</strong><br><small>${user.email}</small></td>
                        <td>${statusHtml}</td>
                        <td>${inTime}</td>
                        <td>${outTime}</td>
                        <td><small>${note}</small></td>
                    </tr>
                `;
            }).join('');

            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('total-staff').innerText = staff.length;
            document.getElementById('present-count').innerText = presentCount;
            document.getElementById('leave-count').innerText = leaveCount;
            document.getElementById('absent-count').innerText = staff.length - presentCount - leaveCount;
        }
    </script>
</body>
</html>