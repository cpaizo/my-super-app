<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è€ƒå‹¤ç›£æ§ - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-box { padding: 1rem; border-radius: 10px; text-align: center; color: white; }
        .bg-blue { background-color: #3949ab; }
        .bg-green { background-color: #43a047; }
        .bg-orange { background-color: #fb8c00; }
        .bg-red { background-color: #e53935; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .on-duty { background: #e8f5e9; color: #2e7d32; }
        .off-duty { background: #ffebee; color: #c62828; }
        .on-leave { background: #fff3e0; color: #ef6c00; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <hgroup>
                <h1>ğŸ“Š å³æ™‚è€ƒå‹¤ç›£æ§</h1>
                <p id="today-date">è®€å–ä¸­...</p>
            </hgroup>
            <button class="outline" onclick="location.href='portal.html'">è¿”å›ä¸»é¸å–®</button>
        </header>

        <div class="stat-grid">
            <div class="stat-box bg-blue">
                <div>æ‡‰åˆ°äººæ•¸</div>
                <h2 id="total-staff">0</h2>
            </div>
            <div class="stat-box bg-green">
                <div>å·²æ‰“å¡</div>
                <h2 id="present-count">0</h2>
            </div>
            <div class="stat-box bg-orange">
                <div>è«‹å‡ä¸­</div>
                <h2 id="leave-count">0</h2>
            </div>
            <div class="stat-box bg-red">
                <div>æœªæ‰“å¡</div>
                <h2 id="absent-count">0</h2>
            </div>
        </div>

        <main class="card">
            <h3>ğŸ‘¥ å“¡å·¥å³æ™‚ç‹€æ…‹</h3>
            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th>å“¡å·¥å§“å</th>
                            <th>æ‰“å¡ç‹€æ…‹</th>
                            <th>ä¸Šç­æ‰“å¡</th>
                            <th>ä¸‹ç­æ‰“å¡</th>
                            <th>å‚™è¨»/è«‹å‡è³‡è¨Š</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list">
                        <tr><td colspan="5" aria-busy="true">æ­£åœ¨ç²å–æœ€æ–°è€ƒå‹¤è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <script>
        const todayStr = new Date().toISOString().split('T')[0]; // æ ¼å¼: 2023-10-27

        window.onload = function() {
            document.getElementById('today-date').innerText = "ä»Šæ—¥æ—¥æœŸï¼š" + new Date().toLocaleDateString();
            fetchMonitorData();
        };

        async function fetchMonitorData() {
            try {
                // 1. ç²å–æ‰€æœ‰å“¡å·¥é¡åº¦è³‡æ–™ (ä½œç‚ºå“¡å·¥æ¸…å–®åŸºç¤)
                const { data: users, error: uError } = await _supabase
                    .from('leave_quotas')
                    .select('user_name, user_email');
                
                // å»é™¤é‡è¤‡çš„ Email (å› ç‚ºä¸€å€‹å“¡å·¥å¯èƒ½æœ‰å¤šç¨®å‡åˆ¥é¡åº¦)
                const staffList = Array.from(new Set(users.map(a => a.user_email)))
                    .map(email => users.find(a => a.user_email === email));

                // 2. ç²å–ä»Šæ—¥æ‰“å¡ç´€éŒ„
                const { data: attendance, error: aError } = await _supabase
                    .from('attendance')
                    .select('*')
                    .gte('work_date', todayStr);

                // 3. ç²å–ä»Šæ—¥è«‹å‡ç´€éŒ„ (å·²æ ¸å‡†ä¸”æ™‚é–“æ¶µè“‹ä»Šå¤©)
                const { data: leaves, error: lError } = await _supabase
                    .from('leave_requests')
                    .select('*')
                    .eq('status', 'approved');

                renderMonitor(staffList, attendance, leaves);
            } catch (err) {
                console.error("ç›£æ§è¼‰å…¥éŒ¯èª¤:", err);
            }
        }

        function renderMonitor(staff, attendance, leaves) {
            const tbody = document.getElementById('attendance-list');
            let present = 0;
            let leave = 0;

            tbody.innerHTML = staff.map(user => {
                // æ‰¾è©²å“¡å·¥æ‰“å¡è³‡æ–™
                const record = attendance.find(a => a.user_email === user.user_email);
                // æ‰¾è©²å“¡å·¥ä»Šå¤©æ˜¯å¦åœ¨è«‹å‡æœŸé–“å…§
                const isOnLeave = leaves.find(l => {
                    const now = new Date();
                    return l.user_email === user.user_email && now >= new Date(l.start_time) && now <= new Date(l.end_time);
                });

                let statusHtml = "";
                let timeIn = record?.check_in || "---";
                let timeOut = record?.check_out || "---";
                let note = "";

                if (isOnLeave) {
                    statusHtml = '<span class="status-tag on-leave">è«‹å‡ä¸­</span>';
                    note = `è«‹å‡é¡å‹ï¼š${isOnLeave.leave_type}`;
                    leave++;
                } else if (record) {
                    statusHtml = '<span class="status-tag on-duty">å·²ä¸Šå·¥</span>';
                    present++;
                } else {
                    statusHtml = '<span class="status-tag off-duty">æœªæ‰“å¡</span>';
                }

                return `
                    <tr>
                        <td><strong>${user.user_name}</strong><br><small>${user.user_email}</small></td>
                        <td>${statusHtml}</td>
                        <td>${timeIn}</td>
                        <td>${timeOut}</td>
                        <td>${note}</td>
                    </tr>
                `;
            }).join('');

            // æ›´æ–°çµ±è¨ˆçœ‹æ¿
            document.getElementById('total-staff').innerText = staff.length;
            document.getElementById('present-count').innerText = present;
            document.getElementById('leave-count').innerText = leave;
            document.getElementById('absent-count').innerText = staff.length - present - leave;
        }
    </script>
</body>
</html>