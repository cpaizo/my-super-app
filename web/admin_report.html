<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è€ƒå‹¤ç›£æ§ - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-box { padding: 1.5rem; border-radius: 12px; text-align: center; color: white; transition: transform 0.2s; }
        .stat-box:hover { transform: translateY(-5px); }
        .bg-blue { background-color: #3949ab; }
        .bg-green { background-color: #43a047; }
        .bg-orange { background-color: #fb8c00; }
        .bg-red { background-color: #e53935; }
        .status-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .on-duty { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }
        .off-duty { background: #ffebee; color: #c62828; border: 1px solid #c62828; }
        .on-leave { background: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; }
        small { color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <hgroup>
                <h1>ğŸ“Š å³æ™‚è€ƒå‹¤ç›£æ§ç³»çµ±</h1>
                <p id="today-date">åˆå§‹åŒ–ä¸­...</p>
            </hgroup>
            <nav>
                <ul>
                    <li><button class="outline" onclick="location.href='portal.html'">è¿”å›ä¸»é¸å–®</button></li>
                </ul>
            </nav>
        </header>

        <div class="stat-grid">
            <div class="stat-box bg-blue">
                <small style="color: rgba(255,255,255,0.8)">æ‡‰åˆ°ç¸½äººæ•¸</small>
                <h2 id="total-staff">--</h2>
            </div>
            <div class="stat-box bg-green">
                <small style="color: rgba(255,255,255,0.8)">ä»Šæ—¥å·²æ‰“å¡</small>
                <h2 id="present-count">--</h2>
            </div>
            <div class="stat-box bg-orange">
                <small style="color: rgba(255,255,255,0.8)">æ ¸å‡†è«‹å‡ä¸­</small>
                <h2 id="leave-count">--</h2>
            </div>
            <div class="stat-box bg-red">
                <small style="color: rgba(255,255,255,0.8)">ç¼ºå¸­æœªæ‰“å¡</small>
                <h2 id="absent-count">--</h2>
            </div>
        </div>

        <main class="card">
            <h3>ğŸ‘¥ å“¡å·¥å‹•æ…‹æ¸…å–®</h3>
            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th>å“¡å·¥è³‡è¨Š</th>
                            <th>ç›®å‰ç‹€æ…‹</th>
                            <th>ä¸Šç­æ‰“å¡</th>
                            <th>ä¸‹ç­æ‰“å¡</th>
                            <th>å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list">
                        <tr><td colspan="5" aria-busy="true">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <script>
        // å–å¾—ä»Šæ—¥æ—¥æœŸå­—ä¸² (YYYY-MM-DD)
        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

        window.onload = async function() {
            document.getElementById('today-date').innerText = "æ•¸æ“šçµ±è¨ˆåŸºæº–æ—¥ï¼š" + new Date().toLocaleDateString();
            await fetchMonitorData();
        };

        async function fetchMonitorData() {
            const listBody = document.getElementById('attendance-list');
            
            try {
                // 1. æŠ“å–å“¡å·¥åå–® (å¾é¡åº¦è¡¨ç²å–)
                const { data: users, error: uError } = await _supabase
                    .from('leave_quotas')
                    .select('user_name, user_email');
                
                if (uError) throw uError;

                // ç§»é™¤é‡è¤‡å“¡å·¥
                const uniqueStaff = Array.from(new Map(users.map(u => [u.user_email, u])).values());

                // 2. æŠ“å–ä»Šæ—¥æ‰“å¡ç´€éŒ„ (å°æ‡‰æ‚¨çš„æ‰“å¡æ¬„ä½ï¼Œå‡è¨­æ˜¯ work_date)
                const { data: attendance, error: aError } = await _supabase
                    .from('attendance')
                    .select('*')
                    .eq('work_date', todayStr);

                // 3. æŠ“å–ä»Šæ—¥è«‹å‡ç´€éŒ„
                const { data: leaves, error: lError } = await _supabase
                    .from('leave_requests')
                    .select('*')
                    .eq('status', 'approved');

                renderMonitor(uniqueStaff, attendance || [], leaves || []);

            } catch (err) {
                console.error("ç›£æ§è¼‰å…¥éŒ¯èª¤:", err);
                listBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">âš ï¸ è¼‰å…¥å¤±æ•—: ${err.message}</td></tr>`;
            }
        }

        function renderMonitor(staff, attendance, leaves) {
            const tbody = document.getElementById('attendance-list');
            let present = 0;
            let leaveCount = 0;

            if (staff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">å°šæœªå»ºç«‹ä»»ä½•å“¡å·¥è³‡æ–™ã€‚</td></tr>';
                return;
            }

            tbody.innerHTML = staff.map(user => {
                // æª¢æŸ¥æ˜¯å¦æ‰“å¡
                const record = attendance.find(a => a.user_email === user.user_email);
                
                // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è«‹å‡æœŸé–“å…§
                const nowTime = new Date();
                const activeLeave = leaves.find(l => {
                    return l.user_email === user.user_email && 
                           nowTime >= new Date(l.start_time) && 
                           nowTime <= new Date(l.end_time);
                });

                let statusHtml = "";
                let checkInTime = record ? (record.check_in || '---') : '---';
                let checkOutTime = record ? (record.check_out || '---') : '---';
                let note = "";

                if (activeLeave) {
                    statusHtml = '<span class="status-tag on-leave">ğŸŒ´ è«‹å‡ä¸­</span>';
                    note = `[${activeLeave.leave_type}] ${activeLeave.reason || ''}`;
                    leaveCount++;
                } else if (record) {
                    statusHtml = '<span class="status-tag on-duty">âœ… å·²åˆ°å·¥</span>';
                    present++;
                } else {
                    statusHtml = '<span class="status-tag off-duty">âŒ æœªæ‰“å¡</span>';
                    note = '<span style="color:#ccc">å°šæœªæœ‰ä»Šæ—¥ç´€éŒ„</span>';
                }

                return `
                    <tr>
                        <td><strong>${user.user_name}</strong><br><small>${user.user_email}</small></td>
                        <td>${statusHtml}</td>
                        <td>${checkInTime}</td>
                        <td>${checkOutTime}</td>
                        <td><small>${note}</small></td>
                    </tr>
                `;
            }).join('');

            // æ›´æ–°å„€è¡¨æ¿æ•¸æ“š
            document.getElementById('total-staff').innerText = staff.length;
            document.getElementById('present-count').innerText = present;
            document.getElementById('leave-count').innerText = leaveCount;
            document.getElementById('absent-count').innerText = (staff.length - present - leaveCount);
        }
    </script>
</body>
</html>