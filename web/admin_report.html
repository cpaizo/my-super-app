<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è€ƒå‹¤ç›£æ§ - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-box { padding: 1.5rem; border-radius: 12px; text-align: center; color: white; }
        .bg-blue { background-color: #3949ab; }
        .bg-green { background-color: #43a047; }
        .bg-orange { background-color: #fb8c00; }
        .bg-red { background-color: #e53935; }
        .filter-section { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; background: #fff; padding: 1rem; border-radius: 10px; }
        .status-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; border: 1px solid; }
        .on-duty { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
        .off-duty { background: #ffebee; color: #c62828; border-color: #c62828; }
        .on-leave { background: #fff3e0; color: #ef6c00; border-color: #ef6c00; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <hgroup>
                <h1>ğŸ“Š è€ƒå‹¤å³æ™‚ç›£æ§èˆ‡æ­·å²æŸ¥è©¢</h1>
                <p>ç®¡ç†è€…å°ˆç”¨æ§åˆ¶å°</p>
            </hgroup>
            <button class="outline" onclick="location.href='portal.html'">è¿”å›ä¸»é¸å–®</button>
        </header>

        <div class="filter-section">
            <label for="query-date" style="margin:0; font-weight:bold;">æŸ¥è©¢æ—¥æœŸï¼š</label>
            <input type="date" id="query-date" style="margin:0; width: auto;" onchange="fetchMonitorData()">
            <mark id="date-display"></mark>
        </div>

        <div class="stat-grid">
            <div class="stat-box bg-blue"><small>å“¡å·¥ç¸½æ•¸</small><h2 id="total-staff">0</h2></div>
            <div class="stat-box bg-green"><small>å·²æ‰“å¡</small><h2 id="present-count">0</h2></div>
            <div class="stat-box bg-orange"><small>è«‹å‡ä¸­</small><h2 id="leave-count">0</h2></div>
            <div class="stat-box bg-red"><small>ç¼ºå¸­</small><h2 id="absent-count">0</h2></div>
        </div>

        <main class="card">
            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th>å“¡å·¥å§“å</th>
                            <th>ç›®å‰ç‹€æ…‹</th>
                            <th>ä¸Šç­æ‰“å¡ (In)</th>
                            <th>ä¸‹ç­æ‰“å¡ (Out)</th>
                            <th>ç•¶æ—¥å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list">
                        <tr><td colspan="5" style="text-align:center;">æ­£åœ¨è®€å–è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨ç‚ºä»Šå¤©
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('query-date').value = today;
            fetchMonitorData();
        };

        async function fetchMonitorData() {
            const listBody = document.getElementById('attendance-list');
            const targetDate = document.getElementById('query-date').value; // å–å¾—é¸å®šçš„æ—¥æœŸ (YYYY-MM-DD)
            
            document.getElementById('date-display').innerText = `æ­£åœ¨æŸ¥çœ‹ï¼š${targetDate}`;

            try {
                // 1. æŠ“å–æ­£å¼å“¡å·¥
                const { data: staff, error: sError } = await _supabase
                    .from('employees')
                    .select('full_name, email');
                if (sError) throw sError;

                // 2. æŠ“å–é¸å®šæ—¥æœŸçš„æ‰“å¡ç´€éŒ„
                const { data: logs, error: lError } = await _supabase
                    .from('attendance_logs')
                    .select('user_email, created_at, type')
                    .gte('created_at', targetDate + 'T00:00:00')
                    .lte('created_at', targetDate + 'T23:59:59');
                if (lError) throw lError;

                // 3. æŠ“å–é¸å®šæ—¥æœŸçš„è«‹å‡ç´€éŒ„ (å·²æ ¸å‡†)
                const { data: leaves, error: lvError } = await _supabase
                    .from('leave_requests')
                    .select('*')
                    .eq('status', 'approved');

                renderMonitor(staff || [], logs || [], leaves || [], targetDate);
            } catch (err) {
                console.error("è¼‰å…¥éŒ¯èª¤:", err);
                listBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">âš ï¸ éŒ¯èª¤: ${err.message}</td></tr>`;
            }
        }

        function renderMonitor(staff, logs, leaves, targetDate) {
            const tbody = document.getElementById('attendance-list');
            const targetDateTime = new Date(targetDate + 'T12:00:00'); // å–ç•¶æ—¥ä¸­åˆé€²è¡Œæ¯”è¼ƒ
            let presentCount = 0;
            let leaveCount = 0;

            const punchData = {};
            logs.forEach(log => {
                const email = log.user_email;
                const time = new Date(log.created_at).toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });
                if (!punchData[email]) punchData[email] = { check_in: '---', check_out: '---' };

                if (log.type === 'check_in') {
                    if (punchData[email].check_in === '---' || time < punchData[email].check_in) punchData[email].check_in = time;
                } else if (log.type === 'check_out') {
                    if (punchData[email].check_out === '---' || time > punchData[email].check_out) punchData[email].check_out = time;
                }
            });

            tbody.innerHTML = staff.map(user => {
                const record = punchData[user.email];
                
                // åˆ¤æ–·è©²å“¡å·¥åœ¨ã€Œé¸å®šæ—¥æœŸã€æ˜¯å¦æ­£åœ¨è«‹å‡
                const isOnLeave = leaves.find(l => {
                    const start = new Date(l.start_time);
                    const end = new Date(l.end_time);
                    return l.user_email === user.email && targetDateTime >= start && targetDateTime <= end;
                });

                let statusHtml = "";
                let inTime = record ? record.check_in : '---';
                let outTime = record ? record.check_out : '---';
                let note = "";

                if (isOnLeave) {
                    statusHtml = '<span class="status-tag on-leave">è«‹å‡</span>';
                    note = `[${isOnLeave.leave_type}] ${isOnLeave.reason || ''}`;
                    leaveCount++;
                } else if (record && record.check_in !== '---') {
                    statusHtml = '<span class="status-tag on-duty">å·²åˆ°å·¥</span>';
                    presentCount++;
                } else {
                    statusHtml = '<span class="status-tag off-duty">æœªæ‰“å¡</span>';
                }

                return `
                    <tr>
                        <td><strong>${user.full_name}</strong><br><small>${user.email}</small></td>
                        <td>${statusHtml}</td>
                        <td>${inTime}</td>
                        <td>${outTime}</td>
                        <td><small>${note}</small></td>
                    </tr>
                `;
            }).join('');

            document.getElementById('total-staff').innerText = staff.length;
            document.getElementById('present-count').innerText = presentCount;
            document.getElementById('leave-count').innerText = leaveCount;
            document.getElementById('absent-count').innerText = staff.length - presentCount - leaveCount;
        }
    </script>
</body>
</html>