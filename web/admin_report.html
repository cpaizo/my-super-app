<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è€ƒå‹¤ç›£æ§ - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-box { padding: 1.5rem; border-radius: 12px; text-align: center; color: white; }
        .bg-blue { background-color: #3949ab; }
        .bg-green { background-color: #43a047; }
        .bg-orange { background-color: #fb8c00; }
        .bg-red { background-color: #e53935; }
        .status-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; border: 1px solid; }
        .on-duty { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
        .off-duty { background: #ffebee; color: #c62828; border-color: #c62828; }
        .on-leave { background: #fff3e0; color: #ef6c00; border-color: #ef6c00; }
        table th, table td { vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <hgroup>
                <h1>ğŸ“Š å³æ™‚è€ƒå‹¤ç›£æ§</h1>
                <p id="today-date">æ•¸æ“šè¼‰å…¥ä¸­...</p>
            </hgroup>
            <nav>
                <ul>
                    <li><button class="outline" onclick="location.href='portal.html'">è¿”å›ä¸»é¸å–®</button></li>
                </ul>
            </nav>
        </header>

        <div class="stat-grid">
            <div class="stat-box bg-blue">
                <small>æ‡‰åˆ°ç¸½äººæ•¸</small>
                <h2 id="total-staff">0</h2>
            </div>
            <div class="stat-box bg-green">
                <small>ä»Šæ—¥å·²æ‰“å¡</small>
                <h2 id="present-count">0</h2>
            </div>
            <div class="stat-box bg-orange">
                <small>æ ¸å‡†è«‹å‡ä¸­</small>
                <h2 id="leave-count">0</h2>
            </div>
            <div class="stat-box bg-red">
                <small>ç¼ºå¸­æœªæ‰“å¡</small>
                <h2 id="absent-count">0</h2>
            </div>
        </div>

        <main class="card">
            <h3>ğŸ‘¥ å“¡å·¥å‹•æ…‹æ¸…å–®</h3>
            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th>å“¡å·¥è³‡è¨Š</th>
                            <th>ç›®å‰ç‹€æ…‹</th>
                            <th>ä¸Šç­æ‰“å¡</th>
                            <th>ä¸‹ç­æ‰“å¡</th>
                            <th>å‚™è¨»/è«‹å‡äº‹ç”±</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list">
                        <tr><td colspan="5" aria-busy="true" style="text-align:center;">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™åº«...</td></tr>
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <script>
        // è‡ªå‹•ç”Ÿæˆä»Šæ—¥æ—¥æœŸ YYYY-MM-DD
        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

        window.onload = async function() {
            document.getElementById('today-date').innerText = "çµ±è¨ˆåŸºæº–æ—¥ï¼š" + new Date().toLocaleDateString();
            await fetchMonitorData();
        };

        async function fetchMonitorData() {
            const listBody = document.getElementById('attendance-list');
            
            try {
                // 1. æŠ“å–å“¡å·¥å§“åèˆ‡ Email å°ç…§ (æ”¹å¾ leave_requests ç²å–ï¼Œé¿å… quotas è¡¨æ¬„ä½ç¼ºå¤±)
                const { data: nameData, error: uError } = await _supabase
                    .from('leave_requests')
                    .select('user_name, user_email');
                
                if (uError) throw uError;

                // å»ºç«‹å”¯ä¸€çš„å“¡å·¥å°ç…§è¡¨ (Email -> Name)
                const staffMap = new Map();
                if (nameData) {
                    nameData.forEach(item => {
                        if (item.user_email && !staffMap.has(item.user_email)) {
                            staffMap.set(item.user_email, item.user_name || 'æœªè¨­å§“å');
                        }
                    });
                }

                const uniqueStaff = Array.from(staffMap, ([email, name]) => ({ user_email: email, user_name: name }));

                // 2. æŠ“å–ä»Šæ—¥æ‰“å¡ç´€éŒ„ (è«‹ç¢ºä¿è³‡æ–™è¡¨åç¨±ç‚º attendance)
                const { data: attendance, error: aError } = await _supabase
                    .from('attendance')
                    .select('*')
                    .eq('work_date', todayStr);

                // 3. æŠ“å–ä»Šæ—¥æ ¸å‡†çš„è«‹å‡ç´€éŒ„
                const { data: leaves, error: lError } = await _supabase
                    .from('leave_requests')
                    .select('*')
                    .eq('status', 'approved');

                renderMonitor(uniqueStaff, attendance || [], leaves || []);

            } catch (err) {
                console.error("ç›£æ§è¼‰å…¥éŒ¯èª¤:", err);
                listBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">âš ï¸ è¼‰å…¥å¤±æ•—: ${err.message}</td></tr>`;
            }
        }

        function renderMonitor(staff, attendance, leaves) {
            const tbody = document.getElementById('attendance-list');
            let present = 0;
            let leaveCount = 0;

            if (staff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ç›®å‰ç³»çµ±ä¸­å°šç„¡å“¡å·¥ç´€éŒ„ (éœ€è‡³å°‘æœ‰ä¸€ç­†è«‹å‡ç”³è«‹ç´€éŒ„)</td></tr>';
                return;
            }

            tbody.innerHTML = staff.map(user => {
                // åˆ¤æ–·æ˜¯å¦æ‰“å¡
                const record = attendance.find(a => a.user_email === user.user_email);
                
                // åˆ¤æ–·æ˜¯å¦æ­£åœ¨è«‹å‡æœŸé–“å…§
                const nowTime = new Date();
                const activeLeave = leaves.find(l => {
                    return l.user_email === user.user_email && 
                           nowTime >= new Date(l.start_time) && 
                           nowTime <= new Date(l.end_time);
                });

                let statusHtml = "";
                let checkIn = record?.check_in || '---';
                let checkOut = record?.check_out || '---';
                let note = "";

                if (activeLeave) {
                    statusHtml = '<span class="status-tag on-leave">è«‹å‡ä¸­</span>';
                    note = `[${activeLeave.leave_type}] ${activeLeave.reason || ''}`;
                    leaveCount++;
                } else if (record) {
                    statusHtml = '<span class="status-tag on-duty">å·²ä¸Šå·¥</span>';
                    present++;
                } else {
                    statusHtml = '<span class="status-tag off-duty">æœªæ‰“å¡</span>';
                    note = '<span style="color:#999">å°šæœªé€²å…¥ç³»çµ±</span>';
                }

                return `
                    <tr>
                        <td><strong>${user.user_name}</strong><br><small>${user.user_email}</small></td>
                        <td>${statusHtml}</td>
                        <td>${checkIn}</td>
                        <td>${checkOut}</td>
                        <td><small>${note}</small></td>
                    </tr>
                `;
            }).join('');

            // æ›´æ–°å„€è¡¨æ¿
            document.getElementById('total-staff').innerText = staff.length;
            document.getElementById('present-count').innerText = present;
            document.getElementById('leave-count').innerText = leaveCount;
            document.getElementById('absent-count').innerText = (staff.length - present - leaveCount);
        }
    </script>
</body>
</html>