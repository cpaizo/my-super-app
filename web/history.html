<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººå‡ºå‹¤å ±è¡¨ - ä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body { padding: 20px; max-width: 1000px; margin: auto; background-color: #f0f2f5; }
        .container-card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
        .tag-success { background: #d4edda; color: #155724; }
        .tag-danger { background: #f8d7da; color: #721c24; }
        table th { background: #f8f9fa; }
    </style>
</head>
<body>
    <main class="container-card">
        <div class="header-nav">
            <h2 style="margin:0;">ğŸ“Š å‡ºå‹¤ç´€éŒ„å ±è¡¨</h2>
            <button class="outline" onclick="location.href='portal.html'" style="width:auto; margin:0;">è¿”å›ä¸»é¸å–®</button>
        </div>

        <p>å“¡å·¥å§“åï¼š<strong id="display-name" style="color:#357ebd;">---</strong> 
           | å¸³è™Ÿï¼š<strong id="display-email">---</strong></p>

        <figure>
            <table role="grid">
                <thead>
                    <tr>
                        <th>å§“å</th> <th>æ—¥æœŸæ™‚é–“</th>
                        <th>é¡å‹</th>
                        <th>è·é›¢å…¬å¸</th>
                        <th>ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody id="log-content">
                    <tr><td colspan="5" style="text-align:center;">æ­£åœ¨è¼‰å…¥è³‡æ–™...</td></tr>
                </tbody>
            </table>
        </figure>

        <div id="no-data" style="display:none; text-align:center; padding: 2rem; color: #666;">
            ç›®å‰å°šç„¡æ‰“å¡ç´€éŒ„ã€‚
        </div>
    </main>

    <script>
        const uEmail = localStorage.getItem('userEmail');
        const uName = localStorage.getItem('userName'); // å–å¾— localStorage ä¸­çš„å§“å

        window.onload = async function() {
            if (!uEmail) {
                alert("ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥");
                window.location.href = "index.html";
                return;
            }
            // é¡¯ç¤ºæ¨™é¡Œè³‡è¨Š
            document.getElementById('display-email').innerText = uEmail;
            document.getElementById('display-name').innerText = uName || "æœªè¨­å®šå§“å";
            
            await loadLogs();
        };

        async function loadLogs() {
            const tableBody = document.getElementById('log-content');
            
            try {
                const { data, error } = await _supabase
                    .from('attendance_logs')
                    .select('*')
                    .eq('user_email', uEmail)
                    .order('created_at', { ascending: false })
                    .limit(30);

                if (error) throw error;

                if (!data || data.length === 0) {
                    tableBody.innerHTML = "";
                    document.getElementById('no-data').style.display = "block";
                    return;
                }

                tableBody.innerHTML = data.map(log => {
                    const date = new Date(log.created_at);
                    const formattedTime = date.toLocaleString('zh-TW', { 
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false 
                    });

                    const typeBadge = log.type === 'check_in' ? 'ğŸŒ ä¸Šç­' : 'ğŸŒœ ä¸‹ç­';
                    const distanceText = log.distance ? `${log.distance}m` : '--';
                    const statusClass = log.is_within_range ? 'tag-success' : 'tag-danger';
                    const statusText = log.is_within_range ? 'æ­£å¸¸' : 'ç•°å¸¸';
                    
                    // å¾è³‡æ–™åº«æ¯ç­†ç´€éŒ„ä¸­å–å‡º user_name
                    const rowName = log.user_name || uName || "å“¡å·¥";

                    return `
                        <tr>
                            <td><strong>${rowName}</strong></td>
                            <td>${formattedTime}</td>
                            <td>${typeBadge}</td>
                            <td>${distanceText}</td>
                            <td><span class="status-tag ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error("Fetch Error:", err);
                tableBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">è®€å–å¤±æ•—ï¼š${err.message}</td></tr>`;
            }
        }
    </script>
</body>
</html>