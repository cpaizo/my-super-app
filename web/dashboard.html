<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­ç®¡ç†ç³»çµ± - å“¡å·¥ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #4a90e2; --secondary-color: #67c23a;
            --warning-color: #f39c12; --danger-color: #e74c3c;
            --excel-color: #27ae60; --bg-color: #f4f7f6;
        }
        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background: var(--bg-color); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f2f5; padding-bottom: 15px; }
        .tag { background: #eef2f7; padding: 6px 15px; border-radius: 50px; font-size: 13px; color: #555; }
        .order-card { background: #fff; padding: 20px; border-radius: 15px; border: 2px solid #eef2f7; margin-bottom: 25px; text-align: center; }
        .meal-select { padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd; width: 280px; margin-right: 10px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-meal { background: var(--secondary-color); }
        .btn-excel { background: var(--excel-color); }
        .btn-refresh { background: #95a5a6; padding: 5px 10px; font-size: 12px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; border: 1px solid #f0f0f0; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .full-width { grid-column: span 2; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .admin-table th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .total-highlight { font-size: 22px; font-weight: bold; color: var(--danger-color); text-align: right; margin-top: 20px; }
        .logout-link { color: #aaa; text-decoration: none; font-size: 13px; display: block; text-align: center; margin-top: 30px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h2 style="margin:0;">ä½ å¥½ï¼Œ<span id="welcome-name" style="color:var(--primary-color);">è®€å–ä¸­...</span></h2>
            <p style="margin:5px 0 0 0; color:#888; font-size:14px;">å·¥è™Ÿï¼š<span id="display-id">---</span></p>
        </div>
        <div>
            <span class="tag" id="display-email">Email</span>
        </div>
    </div>

    <div class="order-card">
        <span id="today-date-label" style="font-size: 18px; font-weight: bold; margin-right: 15px;">æ—¥æœŸåŠ è¼‰ä¸­...</span>
        <select id="meal-select" class="meal-select">
            <option value="æ’éª¨é£¯">æ’éª¨é£¯ ($120)</option>
            <option value="é›æ’é£¯">é›æ’é£¯ ($120)</option>
            <option value="é›è…¿é£¯">é›è…¿é£¯ ($130)</option>
            <option value="ç´ é£Ÿä¾¿ç•¶">ç´ é£Ÿä¾¿ç•¶ ($70)</option>
        </select>
        <button class="btn btn-meal" onclick="orderMeal()">é€å‡ºç™»è¨˜</button>
    </div>

    <div class="dashboard-grid">
        <div class="card full-width" style="background: #fffdf0; border-color: #fbe6c2;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="personal-bill-title" style="margin:0; color:#d35400;">æˆ‘çš„è³¼é¤å¸³å–®</h3>
                <button class="btn btn-refresh" onclick="refreshPersonalStats()">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div id="personal-stats-container">è¨ˆç®—ä¸­...</div>
        </div>

        <div id="admin-stats-box" class="card full-width hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:var(--danger-color);">âš™ï¸ ç®¡ç†å“¡å°å¸³ä¸­å¿ƒ</h3>
                <div>
                    <button class="btn btn-excel" onclick="exportToCSV()">ğŸ“¥ åŒ¯å‡º Excel</button>
                    <button class="btn btn-refresh" style="background:var(--danger-color);" onclick="refreshAdminStats()">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
                </div>
            </div>
            <div id="admin-meal-container">è®€å–ä¸­...</div>
        </div>
    </div>

    <a href="#" class="logout-link" onclick="logout()">ğŸšª å®‰å…¨ç™»å‡ºç³»çµ±</a>
</div>

<script src="js/supabase.js"></script>
<script>
    const mealPrices = { "æ’éª¨é£¯": 120, "é›æ’é£¯": 120, "é›è…¿é£¯": 130, "ç´ é£Ÿä¾¿ç•¶": 70 };
    
    // å¾è³‡æ–™åº«æŠ“åˆ°çš„æ­£ç¢ºè³‡è¨Š
    const userName = localStorage.getItem('userName');
    const userEmail = localStorage.getItem('userEmail');
    const userRole = localStorage.getItem('userRole');
    const employeeId = localStorage.getItem('employeeId');

    const now = new Date();
    const currentMonth = now.getMonth() + 1;

    if (!userEmail) {
        window.location.href = "index.html";
    } else {
        // æ›´æ–° UI
        document.getElementById('welcome-name').innerText = userName;
        document.getElementById('display-id').innerText = employeeId;
        document.getElementById('display-email').innerText = userEmail;
        document.getElementById('today-date-label').innerText = `ä»Šå¤© ${now.getFullYear()}å¹´${currentMonth}æœˆ${now.getDate()}æ—¥ é»é¤ï¼š`;
        document.getElementById('personal-bill-title').innerText = `ğŸ“… ${userName} çš„ ${currentMonth}æœˆ å¸³å–®æ˜ç´°`;

        if (userRole === 'admin') {
            document.getElementById('admin-stats-box').classList.remove('hidden');
            refreshAdminStats();
        }
        refreshPersonalStats();
    }

    // [è³¼é¤ç™»è¨˜] - ä½¿ç”¨è³‡æ–™åº«çš„çœŸå¯¦å§“å
    async function orderMeal() {
        const meal = document.getElementById('meal-select').value;
        const { error } = await _supabase.from('meal_orders').insert([{ 
            user_name: userName, 
            user_email: userEmail, 
            meal_option: meal 
        }]);
        if (error) alert("ç™»è¨˜å¤±æ•—");
        else {
            alert("âœ… å·²æˆåŠŸç™»è¨˜");
            refreshPersonalStats();
            if (userRole === 'admin') refreshAdminStats();
        }
    }

    // [å€‹äººçµ±è¨ˆ]
    async function refreshPersonalStats() {
        const container = document.getElementById('personal-stats-container');
        const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
        const { data } = await _supabase.from('meal_orders').select('meal_option')
            .eq('user_email', userEmail).gte('created_at', monthStart);

        if (!data || data.length === 0) {
            container.innerHTML = "<p style='color:#999'>æœ¬æœˆå°šç„¡è³‡æ–™</p>";
            return;
        }

        let stats = {}, total = 0;
        data.forEach(d => {
            stats[d.meal_option] = (stats[d.meal_option] || 0) + 1;
            total += (mealPrices[d.meal_option] || 0);
        });

        let listHtml = Object.entries(stats).map(([n, c]) => `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f9f9f9;">
                <span>${n}</span><span>${c} æ¬¡</span>
            </div>`).join('');
            
        container.innerHTML = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:40px; margin-top:15px;">
            <div>${listHtml}</div>
            <div style="text-align:right;"><span style="color:#666;">æœ¬æœˆåˆè¨ˆï¼š</span><div style="font-size:36px; font-weight:bold; color:#d35400;">$${total}</div></div>
        </div>`;
    }

    // [ç®¡ç†å“¡å…¨é«”å°å¸³]
    async function refreshAdminStats() {
        const container = document.getElementById('admin-meal-container');
        const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
        const { data, error } = await _supabase.from('meal_orders').select('*').gte('created_at', monthStart);

        if (error || !data || data.length === 0) {
            container.innerHTML = "<p style='padding:20px; color:#999;'>æš«ç„¡è³‡æ–™</p>";
            return;
        }

        const userMap = {};
        data.forEach(order => {
            const email = order.user_email;
            if (!userMap[email]) {
                userMap[email] = { name: order.user_name, meals: {}, total: 0 };
            }
            const meal = order.meal_option;
            userMap[email].meals[meal] = (userMap[email].meals[meal] || 0) + 1;
            userMap[email].total += (mealPrices[meal] || 0);
        });

        let tableHtml = `<table class="admin-table"><thead><tr><th>å§“å</th><th>Email</th><th>æ˜ç´°</th><th>ç¸½é¡</th></tr></thead><tbody>`;
        let grandTotal = 0;
        for (const email in userMap) {
            const u = userMap[email];
            const detail = Object.entries(u.meals).map(([m, c]) => `${m}x${c}`).join(', ');
            tableHtml += `<tr><td><strong>${u.name}</strong></td><td style="color:#888;">${email}</td><td>${detail}</td><td style="font-weight:bold; color:#d35400;">$${u.total}</td></tr>`;
            grandTotal += u.total;
        }
        tableHtml += `</tbody></table><div class="total-highlight">å…¬å¸æœˆçµï¼š$${grandTotal}</div>`;
        container.innerHTML = tableHtml;
    }

    // [åŒ¯å‡º CSV]
    function exportToCSV() {
        const rows = document.querySelectorAll(".admin-table tr");
        if (rows.length === 0) return alert("ç„¡è³‡æ–™");
        let csv = "\ufeffå§“å,Email,æ˜ç´°,ç¸½è¨ˆ\n";
        document.querySelectorAll(".admin-table tbody tr").forEach(row => {
            const cols = row.querySelectorAll("td");
            const rowData = Array.from(cols).map(c => `"${c.innerText.replace(/"/g, '""')}"`);
            csv += rowData.join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `çµå¸³å ±è¡¨_${currentMonth}æœˆ.csv`;
        link.click();
    }

    function logout() { localStorage.clear(); window.location.href = "index.html"; }
</script>
</body>
</html>